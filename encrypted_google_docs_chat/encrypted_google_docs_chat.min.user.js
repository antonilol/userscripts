// ==UserScript==
// @name         Encrypted Google Docs Chat
// @namespace    https://github.com/antonilol/userscripts
// @version      1.0.3
// @description  End to end encryption between users in Google Docs chat
// @author       antonilol
// @updateURL    https://raw.githubusercontent.com/antonilol/userscripts/master/encrypted_google_docs_chat/encrypted_google_docs_chat.min.meta.js
// @downloadURL  https://raw.githubusercontent.com/antonilol/userscripts/master/encrypted_google_docs_chat/encrypted_google_docs_chat.min.user.js
// @match        https://docs.google.com/document/d/*
// @grant        none
// @require      https://raw.githubusercontent.com/antonilol/userscripts/master/encrypted_google_docs_chat/forge.min.js
// ==/UserScript==

(()=>{function d(e,t=document){return t.getElementsByClassName(e).item(0)}const u=window.forge,c={},l=[];var p,n,i,h,r,a,o,m,f,y,g=!0;function v(e){return u.pki.getPublicKeyFingerprint(e,{md:u.md.sha256.create(),encoding:"hex"})}function b(e){if(g){var t=e;var s=Object.keys(c);if(!s.filter(e=>c[e].rsa).length)return t;const n=u.random.getBytesSync(32),i=u.random.getBytesSync(16),r=u.cipher.createCipher("AES-CBC",n);return r.start({iv:i}),r.update(u.util.createBuffer(t)),r.finish()?(l.push(n+i),[u.util.encode64(r.output.data),...s.filter(e=>c[e].rsa).map(e=>u.util.encode64(u.util.hexToBytes(e)+c[e].rsa.encrypt(n+i)))].join("\n")):void 0}return e}function k(e,t){if(t){if(!c[t.id])try{if(442==e.replace(/\n/g,"").length){var s=u.pki.publicKeyFromPem(e);if(s&&s.e&&s.n&&s.encrypt)return v(s)!=v(n)||p&&p.id!=t.id?(c[t.id]={name:t.name,rsa:s},{status:`Public key received from ${t.name}.`}):(p=t,{status:"Public key sent."})}}catch(e){}s=function(e,t){try{var s;if((r=e.split("\n")).length<2)return e;for(s=0;s<r.length;s++)r[s]=u.util.decode64(r[s]);var n,i=r.shift(),r=r.filter(e=>u.util.bytesToHex(e.slice(0,8))==p.id).map(e=>e.slice(8));for(t&&(r=l),s=0;s<r.length;s++)try{if(t)n=r[s];else if(48!=(n=h.decrypt(r[s])).length)continue;var c=n.slice(0,32),a=n.slice(32);const o=u.cipher.createDecipher("AES-CBC",c);if(o.start({iv:a}),o.update(u.util.createBuffer(i)),o.finish())return t&&delete l[s],o.output.data}catch(e){}}catch(e){}return e}(e,t.id==(p&&p.id));return{message:s,decrypted:s!=e}}return e.endsWith("has opened the document.")&&setTimeout(()=>x(i),0),e}function x(e){m=e,r.dispatchEvent(new KeyboardEvent("keydown",{keyCode:13}))}function C(){y.observe(a,{childList:!0,subtree:!0})}u.pki.rsa.generateKeyPair({bits:2048,workers:2},(e,t)=>{e&&console.error(e),n=t.publicKey,h=t.privateKey,i=u.pki.publicKeyToPem(n)}),function e(){if(r=d("docs-chat-edit-box"),a=d("docs-chat-messages"),o=d("docs-chat-title-message"),r&&a&&o&&i){r.addEventListener("keydown",e=>{13==e.keyCode&&(e.isTrusted?r.value&&(r.value=b(r.value)):(f=r.value,r.value=m))},!0),r.addEventListener("keydown",e=>{13!=e.keyCode||e.isTrusted||setTimeout(()=>{r.value=f},10)}),y=new MutationObserver(()=>{y.disconnect(),[...a.children].forEach(e=>{const t=e.classList;if(![...t].includes("decrypted")){var s=t.value;if(t.add("decrypted"),"docs-chat-message docs-chat-status-message"==s){const n=d("docs-chat-status",e);n&&(n.innerText=k(n.innerText))}else if("docs-chat-message"==s){const i=d("docs-chat-nametag",e),r=d("docs-presence-plus-collab-widget-container",e),c=d("docs-chat-message-body",e);if(c&&i&&r)if(s=k(c.innerText,{name:i.innerText,id:r.getAttribute("data-sessionid")})){if(s.status){for(t.add("docs-chat-status-message");e.firstChild;)e.removeChild(e.firstChild);const a=document.createElement("span");a.classList.add("docs-chat-status"),a.innerText=s.status,e.appendChild(a)}else if(c.innerText=s.message,s.decrypted){const o=document.createElement("img");o.src="https://raw.githubusercontent.com/antonilol/userscripts/master/encrypted_google_docs_chat/lock.svg",o.style.marginBottom="-12px",o.style.marginLeft="3px",o.style.width="16px",i.parentNode.insertBefore(o,i),i.style.color="#009900"}}else e.remove()}}}),C()}),C(),setTimeout(()=>x(i),2500);const s=document.createElement("label"),n=(s.style.font="normal 500 12px/16px Roboto,sans-serif",document.createElement("input"));n.type="checkbox",n.checked=!0,n.addEventListener("change",e=>{g=n.checked});var t=document.createTextNode("Encrypt messages");s.appendChild(n),s.appendChild(t),o.appendChild(s)}else setTimeout(e,500)}()})();
