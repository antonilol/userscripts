// ==UserScript==
// @name         Encrypted Google Docs Chat
// @namespace    https://github.com/antonilol/userscripts
// @version      1.0.2
// @description  End to end encryption between users in Google Docs chat
// @author       antonilol
// @updateURL    https://raw.githubusercontent.com/antonilol/userscripts/master/encrypted_google_docs_chat/encrypted_google_docs_chat.min.meta.js
// @downloadURL  https://raw.githubusercontent.com/antonilol/userscripts/master/encrypted_google_docs_chat/encrypted_google_docs_chat.min.user.js
// @match        https://docs.google.com/document/d/*
// @grant        none
// @require      https://raw.githubusercontent.com/antonilol/userscripts/master/encrypted_google_docs_chat/forge.min.js
// ==/UserScript==

(()=>{function d(e,t=document){return t.getElementsByClassName(e).item(0)}const u=window.forge,r={},l=[];var h,i,n,f,t,s,c,a,o;function m(e){return u.pki.getPublicKeyFingerprint(e,{md:u.md.sha256.create(),encoding:"hex"})}function p(e){{var t=Object.keys(r);if(!t.filter(e=>r[e].rsa).length)return e;const s=u.random.getBytesSync(32),i=u.random.getBytesSync(16),n=u.cipher.createCipher("AES-CBC",s);return n.start({iv:i}),n.update(u.util.createBuffer(e)),n.finish()?(l.push(s+i),[u.util.encode64(n.output.data),...t.filter(e=>r[e].rsa).map(e=>u.util.encode64(u.util.hexToBytes(e)+r[e].rsa.encrypt(s+i)))].join("\n")):void 0}}function y(e,t){if(t){if(!r[t.id])try{if(442==e.replace(/\n/g,"").length){var s=u.pki.publicKeyFromPem(e);if(s&&s.e&&s.n&&s.encrypt)return m(s)!=m(i)||h&&h.id!=t.id?(r[t.id]={name:t.name,rsa:s},{status:`Public key received from ${t.name}.`}):(h=t,{status:"Public key sent."})}}catch(e){}s=function(e,t){try{var s;if((r=e.split("\n")).length<2)return e;for(s=0;s<r.length;s++)r[s]=u.util.decode64(r[s]);var i,n=r.shift(),r=r.filter(e=>u.util.bytesToHex(e.slice(0,8))==h.id).map(e=>e.slice(8));for(t&&(r=l),s=0;s<r.length;s++)try{if(t)i=r[s];else if(48!=(i=f.decrypt(r[s])).length)continue;var c=i.slice(0,32),a=i.slice(32);const o=u.cipher.createDecipher("AES-CBC",c);if(o.start({iv:a}),o.update(u.util.createBuffer(n)),o.finish())return t&&delete l[s],o.output.data}catch(e){}}catch(e){}return e}(e,t.id==(h&&h.id));return{message:s,decrypted:s!=e}}return e.endsWith("has opened the document.")&&setTimeout(()=>g(n),0),e}function g(e){c=e,t.dispatchEvent(new KeyboardEvent("keydown",{keyCode:13}))}function v(){o.observe(s,{childList:!0,subtree:!0})}u.pki.rsa.generateKeyPair({bits:2048,workers:2},(e,t)=>{e&&console.error(e),i=t.publicKey,f=t.privateKey,n=u.pki.publicKeyToPem(i)}),function e(){t=d("docs-chat-edit-box"),s=d("docs-chat-messages"),t&&s&&n?(t.addEventListener("keydown",e=>{13==e.keyCode&&(e.isTrusted?t.value&&(t.value=p(t.value)):(a=t.value,t.value=c))},!0),t.addEventListener("keydown",e=>{13!=e.keyCode||e.isTrusted||setTimeout(()=>{t.value=a},10)}),o=new MutationObserver(()=>{o.disconnect(),[...s.children].forEach(e=>{const t=e.classList;if(![...t].includes("decrypted")){var s=t.value;if(t.add("decrypted"),"docs-chat-message docs-chat-status-message"==s){const i=d("docs-chat-status",e);i&&(i.innerText=y(i.innerText))}else if("docs-chat-message"==s){const n=d("docs-chat-nametag",e),r=d("docs-presence-plus-collab-widget-container",e),c=d("docs-chat-message-body",e);if(c&&n&&r)if(s=y(c.innerText,{name:n.innerText,id:r.getAttribute("data-sessionid")})){if(s.status){for(t.add("docs-chat-status-message");e.firstChild;)e.removeChild(e.firstChild);const a=document.createElement("span");a.classList.add("docs-chat-status"),a.innerText=s.status,e.appendChild(a)}else if(c.innerText=s.message,s.decrypted){const o=document.createElement("img");o.src="https://raw.githubusercontent.com/antonilol/userscripts/master/encrypted_google_docs_chat/lock.svg",o.style.marginBottom="-12px",o.style.marginLeft="3px",o.style.width="16px",n.parentNode.insertBefore(o,n),n.style.color="#009900"}}else e.remove()}}}),v()}),v(),setTimeout(()=>g(n),2500)):setTimeout(e,500)}()})();
